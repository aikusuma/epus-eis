// Prisma schema for PostgreSQL - Operational & ACL database
// This is the source of truth for users, roles, ACL, and master data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & ACCESS CONTROL
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String    @map("password_hash")
  nama          String
  nip           String?   @unique
  jabatan       String?
  telepon       String?
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  roleId      String      @map("role_id")
  role        Role        @relation(fields: [roleId], references: [id])
  puskesmasId String?     @map("puskesmas_id")
  puskesmas   Puskesmas?  @relation(fields: [puskesmasId], references: [id])
  wilayahId   String?     @map("wilayah_id")
  wilayah     Wilayah?    @relation(fields: [wilayahId], references: [id])
  auditLogs   AuditLog[]
  sessions    Session[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  code        String   @unique // 'kepala_dinkes', 'kabid', 'kepala_puskesmas', 'staf'
  name        String
  description String?
  level       Int      @default(0) // hierarchy level
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique // 'view_all_puskesmas', 'view_own_puskesmas', 'manage_users', etc.
  name        String
  description String?
  module      String   // 'dashboard', 'puskesmas', 'users', 'reports', etc.
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================
// MASTER DATA - WILAYAH & PUSKESMAS
// ============================================

model Wilayah {
  id             String   @id @default(cuid())
  kodeKecamatan  String   @unique @map("kode_kecamatan")
  namaKecamatan  String   @map("nama_kecamatan")
  kodeKabupaten  String   @default("3329") @map("kode_kabupaten") // Brebes
  namaKabupaten  String   @default("Brebes") @map("nama_kabupaten")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  puskesmas Puskesmas[]
  users     User[]

  @@map("wilayah")
}

model Puskesmas {
  id             String   @id @default(cuid())
  kodePuskesmas  String   @unique @map("kode_puskesmas")
  namaPuskesmas  String   @map("nama_puskesmas")
  alamat         String?
  telepon        String?
  email          String?
  jenis          String   @default("non_rawat_inap") // 'rawat_inap', 'non_rawat_inap'
  status         String   @default("aktif") // 'aktif', 'tidak_aktif'
  latitude       Float?
  longitude      Float?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  wilayahId String  @map("wilayah_id")
  wilayah   Wilayah @relation(fields: [wilayahId], references: [id])
  users     User[]

  @@map("puskesmas")
}

// ============================================
// MASTER DATA - ICD-10
// ============================================

model Icd10 {
  id        String   @id @default(cuid())
  code      String   @unique
  display   String
  version   String   @default("ICD10_2010")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  diagnoses DiagnosisDummy[]

  @@index([code])
  @@map("icd10")
}

// Dummy data untuk demo - Diagnosis pasien
model DiagnosisDummy {
  id            String   @id @default(cuid())
  icd10Id       String   @map("icd10_id")
  icd10         Icd10    @relation(fields: [icd10Id], references: [id])
  pasienNama    String   @map("pasien_nama")
  pasienUmur    Int      @map("pasien_umur")
  pasienGender  String   @map("pasien_gender") // L / P
  puskesmas     String
  tanggalPeriksa DateTime @map("tanggal_periksa")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([icd10Id])
  @@index([tanggalPeriksa])
  @@map("diagnosis_dummy")
}

// ============================================
// INGESTION LOG (Raw data from e-Puskesmas)
// ============================================

model IngestionLog {
  id          String   @id @default(cuid())
  eventType   String   @map("event_type") // 'kunjungan', 'diagnosis', 'program'
  puskesmasId String   @map("puskesmas_id")
  payload     Json     // Raw JSON payload
  status      String   @default("pending") // 'pending', 'processed', 'failed'
  errorMsg    String?  @map("error_msg")
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([eventType])
  @@index([createdAt])
  @@map("ingestion_logs")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String   // 'login', 'logout', 'view_dashboard', 'export_report', etc.
  resource   String?  // 'dashboard', 'puskesmas', 'report', etc.
  resourceId String?  @map("resource_id")
  details    Json?    // Additional details
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// SYSTEM CONFIG
// ============================================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string") // 'string', 'number', 'boolean', 'json'
  module    String   @default("general")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// ============================================
// KLASTER 1: SDM, OBAT, KEUANGAN
// ============================================

model TenagaKesehatan {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  kategori      String   // 'Dokter Umum', 'Dokter Gigi', 'Bidan', 'Perawat', 'Apoteker', 'Analis Lab'
  jumlah        Int
  target        Int
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, kategori, bulan, tahun])
  @@index([puskesmasId])
  @@map("tenaga_kesehatan")
}

model StokObat {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  namaObat      String   @map("nama_obat")
  satuan        String
  stok          Int
  pemakaian     Int
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, namaObat, bulan, tahun])
  @@index([puskesmasId])
  @@map("stok_obat")
}

model Keuangan {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  kategori      String   // 'Pendapatan JKN', 'Pendapatan Umum', 'BLUD', 'DAK'
  nominal       Float
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, kategori, bulan, tahun])
  @@index([puskesmasId])
  @@map("keuangan")
}

// ============================================
// KLASTER 2: IBU DAN ANAK
// ============================================

model AntenatalCare {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  k1            Int
  k4            Int
  target        Int
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, bulan, tahun])
  @@index([puskesmasId])
  @@map("antenatal_care")
}

model Imunisasi {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  jenisImunisasi String  @map("jenis_imunisasi") // 'HB-0', 'BCG', 'Polio 1', etc.
  kategori      String   // 'bayi', 'baduta', 'bias'
  sasaran       Int
  capaian       Int
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, jenisImunisasi, bulan, tahun])
  @@index([puskesmasId])
  @@map("imunisasi")
}

// ============================================
// KLASTER 3: DETEKSI DINI & PTM
// ============================================

model DeteksiDini {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  jenis         String   // 'Kanker Serviks (IVA)', 'Kanker Payudara', 'Tuberculosis', etc.
  sasaran       Int
  capaian       Int
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, jenis, bulan, tahun])
  @@index([puskesmasId])
  @@map("deteksi_dini")
}

model FaktorRisiko {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  faktor        String   // 'Hipertensi', 'Diabetes', 'Obesitas', 'Merokok', etc.
  jumlahKasus   Int      @map("jumlah_kasus")
  kelompokUmur  String   @map("kelompok_umur") // '15-24', '25-44', '45-59', '60+'
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, faktor, kelompokUmur, bulan, tahun])
  @@index([puskesmasId])
  @@map("faktor_risiko")
}

model PemeriksaanGigi {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  kategori      String   // 'SD/MI', 'SMP/MTs', 'SMA/SMK'
  sasaran       Int
  diperiksa     Int
  perluPerawatan Int     @map("perlu_perawatan")
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, kategori, bulan, tahun])
  @@index([puskesmasId])
  @@map("pemeriksaan_gigi")
}

// ============================================
// KLASTER 4: PERINGATAN DIAGNOSA
// ============================================

model DiagnosaHarian {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  icd10Code     String   @map("icd10_code")
  diagnosa      String
  jumlahKasus   Int      @map("jumlah_kasus")
  tingkatBahaya String   @map("tingkat_bahaya") // 'tinggi', 'sedang', 'rendah'
  tanggal       DateTime
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([puskesmasId])
  @@index([tanggal])
  @@index([icd10Code])
  @@index([tingkatBahaya])
  @@map("diagnosa_harian")
}

// ============================================
// LINTAS KLASTER
// ============================================

model GawatDarurat {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  triaseMerah   Int      @map("triase_merah")
  triaseKuning  Int      @map("triase_kuning")
  triaseHijau   Int      @map("triase_hijau")
  tanggal       DateTime
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([puskesmasId, tanggal])
  @@index([puskesmasId])
  @@index([tanggal])
  @@map("gawat_darurat")
}

model Farmasi {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  jumlahResep   Int      @map("jumlah_resep")
  obatKeluar    Int      @map("obat_keluar")
  racikan       Int
  tanggal       DateTime
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([puskesmasId, tanggal])
  @@index([puskesmasId])
  @@index([tanggal])
  @@map("farmasi")
}

model Laboratorium {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  jumlahPemeriksaan Int  @map("jumlah_pemeriksaan")
  hematologi    Int
  kimiaKlinik   Int      @map("kimia_klinik")
  urinalisis    Int
  tanggal       DateTime
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([puskesmasId, tanggal])
  @@index([puskesmasId])
  @@index([tanggal])
  @@map("laboratorium")
}

model RawatInap {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  pasienMasuk   Int      @map("pasien_masuk")
  pasienKeluar  Int      @map("pasien_keluar")
  bedTerisi     Int      @map("bed_terisi")
  bedTotal      Int      @map("bed_total")
  tanggal       DateTime
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([puskesmasId, tanggal])
  @@index([puskesmasId])
  @@index([tanggal])
  @@map("rawat_inap")
}

// ============================================
// MONITORING: KUNJUNGAN & PASIEN
// ============================================

model Kunjungan {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  jenisLayanan  String   @map("jenis_layanan") // 'Rawat Jalan', 'UGD', 'Rawat Inap', etc.
  pasienNama    String   @map("pasien_nama")
  pasienUmur    Int      @map("pasien_umur")
  pasienGender  String   @map("pasien_gender") // 'L', 'P'
  pasienAlamat  String?  @map("pasien_alamat")
  pasienDesa    String?  @map("pasien_desa")
  icd10Code     String?  @map("icd10_code")
  diagnosa      String?
  keluhan       String?
  obat          String?
  tanggal       DateTime
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([puskesmasId])
  @@index([tanggal])
  @@index([icd10Code])
  @@index([pasienDesa])
  @@map("kunjungan")
}

model TopDiagnosa {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  icd10Code     String   @map("icd10_code")
  diagnosa      String
  jumlahKasus   Int      @map("jumlah_kasus")
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([puskesmasId, icd10Code, bulan, tahun])
  @@index([puskesmasId])
  @@map("top_diagnosa")
}

model TopKeluhan {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  keluhan       String
  jumlahKasus   Int      @map("jumlah_kasus")
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([puskesmasId, keluhan, bulan, tahun])
  @@index([puskesmasId])
  @@map("top_keluhan")
}

model TopObat {
  id            String   @id @default(cuid())
  puskesmasId   String   @map("puskesmas_id")
  namaObat      String   @map("nama_obat")
  jumlahResep   Int      @map("jumlah_resep")
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([puskesmasId, namaObat, bulan, tahun])
  @@index([puskesmasId])
  @@map("top_obat")
}

// ============================================
// OVERVIEW SUMMARY (Aggregated data for dashboard)
// ============================================

model OverviewSummary {
  id            String   @id @default(cuid())
  puskesmasId   String?  @map("puskesmas_id") // null = kabupaten level
  totalKunjungan Int     @map("total_kunjungan")
  kunjunganBaru Int      @map("kunjungan_baru")
  kunjunganLama Int      @map("kunjungan_lama")
  pasienBpjs    Int      @map("pasien_bpjs")
  pasienUmum    Int      @map("pasien_umum")
  bulan         Int
  tahun         Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([puskesmasId, bulan, tahun])
  @@index([bulan, tahun])
  @@map("overview_summary")
}
